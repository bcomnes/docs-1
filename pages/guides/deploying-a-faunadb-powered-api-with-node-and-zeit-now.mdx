import Guide from '~/components/layout/guide'
import Snippet from '~/components/snippet'
import { InlineCode } from '~/components/text/code'
import { Image } from '~/components/media'
import Caption from '~/components/text/caption'
import Note from '~/components/text/note'
import { GenericLink } from '~/components/text/link'
import Card from '~/components/card'
import { Code } from '~/components/code'

export const meta = {
  title: 'Create and Deploy a FaunaDB-Powered Node.js API with ZEIT Now',
  description:
    'Create a FaunaDB-Powered Node.js API and deploy it with ZEIT Now.',
  published: '2019-08-27T17:00:00.000Z',
  authors: ['danieltodonnell', 'msweeneydev'],
  url: '/guides/deploying-a-faunadb-powered-api-with-node-and-zeit-now',
  image: `${
    process.env.ASSETS
  }/guides/deploying-a-faunadb-powered-api-with-node-and-zeit-now/card.png`,
  editUrl:
    'pages/guides/deploying-a-faunadb-powered-api-with-node-and-zeit-now.mdx',
  lastEdited: '2019-08-27T13:39:59.000Z'
}

[FaunaDB](https://fauna.com/) is a serverless cloud database that gives you ubiquitous, low latency access to app data, without sacrificing data correctness.

This guide walks you through making a FaunaDB account, creating a sample database, and then connecting to it using a Serverless Function deployed with [ZEIT Now](/now).

## Step 1: Connecting to FaunaDB

To start this example, you need to have [created a FaunaDB account](https://dashboard.fauna.com/accounts/register). Once logged in to FaunaDB, create a child database named `zeit` _(names are case sensitive)_.

<Image
  src={`${
    process.env.ASSETS
  }/guides/deploying-a-faunadb-powered-api-with-node-and-zeit-now/fauna-create-zeit-db.png`}
  width={2048 / 2.5}
  height={1628 / 2.5}
  oversize
/>
<Caption>Creating a new database in the FaunaDB dashboard.</Caption>

After clicking **Save**, you will be taken to the **Database Overview** page.

From here, the easiest way to create a demo schema with some data is to execute a _Fauna Query Language (FQL)_ script file.

Select the **Shell** tab from the sidebar, copy in [this FQL script](https://raw.githubusercontent.com/danieltodonnell/faunadb-zeit-fql-demo/master/fql-scripts/ecommerce.fql) and click **Run Query**.

<Image
  src={`${
    process.env.ASSETS
  }/guides/deploying-a-faunadb-powered-api-with-node-and-zeit-now/fauna-zeit-db-shell.png`}
  width={2048 / 2.5}
  height={1536 / 2.5}
  oversize
/>
<Caption>Adding data to a FaunaDB database from the dashboard using a FQL script.</Caption>

After executing the script, the **Collections** page will look like this, you are now ready to create a connection to the database.

<Image
  src={`${
    process.env.ASSETS
  }/guides/deploying-a-faunadb-powered-api-with-node-and-zeit-now/fauna-zeit-db-collections.png`}
  width={2048 / 2.5}
  height={1536 / 2.5}
  oversize
/>
<Caption>The Collections page on the FaunaDB dashboard after adding data to the database.</Caption>

## Step 2: Create an Access Key

Go to the [**Security** page](https://dashboard.fauna.com/keys/@db/zeit) and click the **New Key** button. Enter the following data in the fields:

- Database: `zeit`
- Role: `Admin`
- Key Name: `access`
- Priority: `1`

Once entered, click the **Save** button, which will take you to the **Keys** page.

On the **Keys** page, you will receive a unique hash called a **Secret**. The **Secret** is your method of securely identifying yourself to the database.

<Note warning>
  This is the only time you will see this hash, so record it somewhere private.
  However, if the has is lost, a new one can be created.
</Note>

## Step 3: API Setup

Get started by creating a project directory and `cd` into it:

<Snippet dark text="mkdir faunadb-demo && cd faunadb-demo" />
<Caption>
  Creating and entering into the <InlineCode>/faunadb-demo</InlineCode>{' '}directory.
</Caption>

Next, [initialize](https://docs.npmjs.com/cli/init) the project:

<Snippet dark text="npm init -y" />
<Caption>
  Initializing the project, this creates a <InlineCode>package.json</InlineCode>{' '}file.
</Caption>

Next, install [the FaunaDB Javascript client](https://github.com/fauna/faunadb-js), this helps you connect to and query the database:

<Snippet dark text="npm i faunadb" />
<Caption>
  Adding the <InlineCode>faunadb</InlineCode> Node.js client as a <GenericLink href="https://docs.npmjs.com/specifying-dependencies-and-devdependencies-in-a-package-json-file">dependency</GenericLink> to the project.
</Caption>

To connect, you need the secret received earlier. To use the secret without hard-coding it into your project, add your connection string as a [Now Secret](https://zeit.co/docs/v2/deployments/environment-variables-and-secrets/#securing-environment-variables-using-secrets) using [Now CLI](https://zeit.co/download#now-cli) to keep it secure:

<Snippet dark text="now secrets add faunadb_secret_key YourFaunaDBSecret" />
<Caption>
  Adding an environment variable to the project as a <GenericLink href="/docs/v2/serverless-functions/env-and-secrets/#adding-secrets">Now Secret</GenericLink>.
</Caption>

Now, create a [`now.json` file](https://zeit.co/docs/v2/deployments/configuration/) that tells Now to make available the [Secret](https://zeit.co/docs/v2/deployments/environment-variables-and-secrets/#securing-environment-variables-using-secrets) that you defined:

```json
{
  "env": {
    "FAUNADB_SECRET_KEY": "@faunadb_secret_key"
  }
}
```

<Caption>
  An example <InlineCode>now.json</InlineCode> file that provides the app with
  an environment variable.
</Caption>

<Note hint>
  To use this environment variable{' '}
  <GenericLink href="/docs/v2/serverless-functions/introduction/#local-development">
    during local development
  </GenericLink>
  , you need to add it to a<InlineCode>.env</InlineCode> file.
</Note>

## Step 4: Writing the Serverless Function

It's time to create the Node.js API endpoint that will fetch the data from FaunaDB. Create an `/api` directory with an `index.js` file inside:

<Snippet dark text="mkdir -p api/index.js && cd api" />
<Caption>
  Creating an <InlineCode>/api</InlineCode>{' '}directory with a <InlineCode>index.js</InlineCode> file inside.
</Caption>

The `index.js` file will act as the default endpoint for getting information from your database. The file should contain the following code:

```js
const faunadb = require('faunadb')

// your secret hash
const secret = process.env.FAUNADB_SECRET_KEY
const q = faunadb.query
const client = new faunadb.Client({ secret })

module.exports = async (req, res) => {
  try {
    const dbs = await client.query(
      q.Map(
        // iterate each item in result
        q.Paginate(
          // make paginatable
          q.Match(
            // query index
            q.Index('all_customers') // specify source
          )
        ),
        ref => q.Get(ref) // lookup each result by its reference
      )
    )
    // ok
    res.status(200).json(dbs.data)
  } catch (e) {
    // something went wrong
    res.status(500).json({ error: e.message })
  }
}
```

<Caption>
  An example <InlineCode>/api/index.js</InlineCode> file that retrieves
  information from the database.
</Caption>

## Step 5: Deploying

With the project complete, you are ready to deploy it with [ZEIT Now](/now).

If you have not yet installed Now, you can do so by [installing Now CLI](/download).

You can now deploy the project with **just a single command**:

<Snippet dark text="now" />
<Caption>
  Deploying the project with the <InlineCode>now</InlineCode> command.
</Caption>

You will shortly be given a deployment URL. With this, you can now access the contents of the FaunaDB database at the `/api` endpoint.

To deploy your Node.js + FaunaDB project from a Git repository, you can use either [Now for GitHub](/docs/v2/advanced/now-for-github/) or [Now for GitLab](/docs/v2/advanced/now-for-gitlab/) to have your project automatically deployed on every push, and aliased on push to master.

export default ({ children }) => <Guide meta={meta}>{children}</Guide>

export const config = {
  amp: 'hybrid'
}
